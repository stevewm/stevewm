#
# Updates README.md with latest commit dates
# for repos listed in `config.yaml`
#

name: "Scheduled: Update README.md"
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Midnight: https://crontab.guru/#0_0_*_*_*
  push:
    branches:
      - main
    paths: 
      - README.md.j2
      - repos.py

permissions:
  contents: write

jobs:
  readme:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: "${{ steps.app-token.outputs.token }}"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Run Script
        shell: bash
        env:
          GITHUB_USER: ${{ github.repository_owner }}
          GITHUB_TOKEN: ${{ secrets.READ_REPO_TOKEN }}
        run: uv run repos.py
      
      - name: Update README.md
        uses: EndBug/add-and-commit@v9
        with:
          add: "README.md"
          message: "chore: update README.md"
          committer_name: "botty-hill[bot]"
          committer_email: botty-hill[bot]@users.noreply.github.com
